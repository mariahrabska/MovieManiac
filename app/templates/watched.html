{% extends "base.html" %}
{% block title %}Watched Movies{% endblock %}

{% block content %}
<div class="main-content">
    <div class="container">
        <h2><i class="fas fa-eye"></i> Your Watched Movies:</h2>

        <div class="search-form">

            <!-- Genre Filter -->
            {% if genres %}
            <label for="genre-filter">Filter by Genre:</label>
            <div class="autocomplete-wrapper">
                <select id="genre-filter">
                    <option value="all">All</option>
                    {% for genre in genres %}
                        <option value="{{ genre }}">{{ genre }}</option>
                    {% endfor %}
                </select>
                <!-- tu w przyszłości możesz dodać sugestie -->
            </div>
            {% endif %}

            <!-- Sorting -->
            <label for="sort-by">Sort by:</label>
            <div class="autocomplete-wrapper">
                <select id="sort-by">
                    <option value="title-asc">Title A → Z</option>
                    <option value="title-desc">Title Z → A</option>
                    <option value="year-asc">Year Ascending</option>
                    <option value="year-desc">Year Descending</option>
                </select>
            </div>

        </div>

        {% if watchlist %}
            <ul class="movie-list">
                {% for movie in watchlist %}
                    <li class="movie-item" data-genres="{{ movie.genres }}" data-year="{{ movie.release_year }}">
                        <div class="movie-info">
                            <a href="{{ url_for('main.movie_page', movie_id=movie['movie_id']) }}">
                                {% if movie.poster_path %}
                                    <img src="https://image.tmdb.org/t/p/w92{{ movie.poster_path }}" 
                                         alt="{{ movie.title }}" class="poster-thumb">
                                {% endif %}
                                <span class="movie-title">{{ movie.title }}</span>
                            </a>
                        </div>

                        <div class="movie-actions">
                            <!-- Favorites -->
                            <button class="favorite-btn {% if movie.movie_id in favorite_ids %}favorited{% endif %}"
                                    data-id="{{ movie['movie_id'] }}" title="Favorite">
                                <i class="fas fa-heart"></i>
                            </button>

                            <button class="remove-btn" data-id="{{ movie['movie_id'] }}" title="Remove from watched">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>You don't have any watched movies yet.</p>
        {% endif %}

    </div>
</div>

<script>
// ===============================
// GLOBAL ELEMENTS
// ===============================
const movieList = document.querySelector('.movie-list');
const genreFilter = document.getElementById('genre-filter');
const sortSelect = document.getElementById('sort-by');

// ===============================
// NOTIFICATION FUNCTION
// ===============================
function showNotification(message) {
    let notif = document.getElementById("notification");
    if (!notif) {
        notif = document.createElement("div");
        notif.id = "notification";
        notif.style.position = "fixed";
        notif.style.bottom = "20px";
        notif.style.right = "20px";
        notif.style.padding = "10px 15px";
        notif.style.background = "#333";
        notif.style.color = "#fff";
        notif.style.borderRadius = "5px";
        notif.style.zIndex = 9999;
        notif.style.opacity = 0;
        notif.style.transition = "opacity 0.3s";
        document.body.appendChild(notif);
    }
    notif.textContent = message;
    notif.style.opacity = 1;
    setTimeout(() => notif.style.opacity = 0, 2000);
}

// ===============================
// REMOVE MOVIE
// ===============================
document.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const movie_id = btn.dataset.id;
        fetch('/watched/remove', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({movie_id: movie_id})
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                btn.closest('li').remove();
                showNotification("✔ Movie removed from watched");
            } else {
                showNotification("❌ " + (data.error || "Failed to remove movie"));
            }
        });
    });
});

// ===============================
// TOGGLE FAVORITE
// ===============================
if (movieList) {
    movieList.addEventListener('click', (e) => {
        const btn = e.target.closest('.favorite-btn');
        if (!btn) return;

        const movieId = btn.dataset.id;
        btn.disabled = true;

        fetch('/favorites/toggle', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({movie_id: movieId})
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                btn.classList.toggle('favorited', data.favorited);
                showNotification(data.favorited ? "✔ Added to favorites" : "❌ Removed from favorites");
            } else {
                showNotification("❌ Failed to update favorites");
            }
        })
        .catch(() => showNotification("⚠️ Connection error – Try again."))
        .finally(() => btn.disabled = false);
    });
}

// ===============================
// GENRE FILTER
// ===============================
if (genreFilter) {
    genreFilter.addEventListener('change', () => {
        const selected = genreFilter.value;
        document.querySelectorAll('.movie-item').forEach(item => {
            const movieGenres = item.dataset.genres ? item.dataset.genres.split('|') : [];
            item.style.display = (selected === 'all' || movieGenres.includes(selected)) ? '' : 'none';
        });
    });
}

// ===============================
// SORT MOVIES
// ===============================
if (sortSelect) {
    sortSelect.addEventListener('change', () => {
        const items = Array.from(movieList.querySelectorAll('.movie-item'));
        const sortValue = sortSelect.value;

        items.sort((a, b) => {
            if (sortValue.startsWith('title')) {
                const titleA = a.querySelector('.movie-title').textContent.toLowerCase();
                const titleB = b.querySelector('.movie-title').textContent.toLowerCase();
                return sortValue === 'title-asc' ? titleA.localeCompare(titleB) : titleB.localeCompare(titleA);
            } else if (sortValue.startsWith('year')) {
                const yearA = parseInt(a.dataset.year) || 0;
                const yearB = parseInt(b.dataset.year) || 0;
                return sortValue === 'year-asc' ? yearA - yearB : yearB - yearA;
            }
        });

        items.forEach(item => movieList.appendChild(item));
    });
}
</script>


{% endblock %}
