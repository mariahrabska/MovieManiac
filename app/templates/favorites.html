{% extends "base.html" %}
{% block title %}Favorite Movies{% endblock %}

{% block content %}
<div class="main-content">
    <div class="container">
        <h2><i class="fas fa-heart"></i> Your Favorite Movies:</h2>

        <!-- Genre filter -->
        {% if genres %}
        <label for="genre-filter">Filter by genre:</label>
        <select id="genre-filter">
            <option value="all">All</option>
            {% for genre in genres %}
                <option value="{{ genre }}">{{ genre }}</option>
            {% endfor %}
        </select>
        {% endif %}

        <!-- Sorting -->
        <label for="sort-by">Sort by:</label>
        <select id="sort-by">
            <option value="title-asc">Title A → Z</option>
            <option value="title-desc">Title Z → A</option>
            <option value="year-asc">Year ascending</option>
            <option value="year-desc">Year descending</option>
            <option value="added-desc">Date added (newest)</option>
            <option value="added-asc">Date added (oldest)</option>
        </select>

        <!-- Keyword search -->
        <label for="keyword-search">Search by keywords:</label>
        <input type="text" id="keyword-search" placeholder="Type a keyword...">

        {% if favorites %}
            <ul class="movie-list">
                {% for movie in favorites %}
                    <li class="movie-item" 
                        data-genres="{{ movie.genres }}" 
                        data-year="{{ movie.release_year }}" 
                        data-added="{{ movie.added_at }}" 
                        data-keywords="{{ movie.keywords }}">

                        <div class="movie-info">
                            <a href="{{ url_for('main.movie_page', movie_id=movie.movie_id) }}">
                                {% if movie.poster_path %}
                                    <img src="https://image.tmdb.org/t/p/w92{{ movie.poster_path }}" 
                                         alt="{{ movie.title }}" class="poster-thumb">
                                {% endif %}
                                <span class="movie-title">{{ movie.title }}</span>
                            </a>
                        </div>

                        <div class="movie-actions">
                            <button class="remove-btn" data-id="{{ movie.movie_id }}" title="Remove from favorites">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>You don’t have any favorite movies yet.</p>
        {% endif %}
    </div>
</div>

<script>
// Remove movies from favorites
document.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const movie_id = btn.dataset.id;
        fetch('/favorites/toggle', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({movie_id: movie_id})
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                btn.closest('li').remove();
            } else {
                alert("❌ " + (data.error || "Failed to remove the movie from favorites."));
            }
        });
    });
});

// Filter by genre
const genreFilter = document.getElementById('genre-filter');
if (genreFilter) {
    genreFilter.addEventListener('change', () => {
        const selected = genreFilter.value;
        document.querySelectorAll('.movie-item').forEach(item => {
            const movieGenres = item.dataset.genres ? item.dataset.genres.split('|') : [];
            item.style.display = (selected === 'all' || movieGenres.includes(selected)) ? '' : 'none';
        });
    });
}

// Sorting
const sortSelect = document.getElementById('sort-by');
if (sortSelect) {
    sortSelect.addEventListener('change', () => {
        const ul = document.querySelector('.movie-list');
        const items = Array.from(ul.querySelectorAll('.movie-item'));
        const sortValue = sortSelect.value;

        items.sort((a, b) => {
            if (sortValue.startsWith('title')) {
                const titleA = a.querySelector('.movie-title').textContent.toLowerCase();
                const titleB = b.querySelector('.movie-title').textContent.toLowerCase();
                return sortValue === 'title-asc' ? titleA.localeCompare(titleB) : titleB.localeCompare(titleA);
            } else if (sortValue.startsWith('year')) {
                const yearA = parseInt(a.dataset.year) || 0;
                const yearB = parseInt(b.dataset.year) || 0;
                return sortValue === 'year-asc' ? yearA - yearB : yearB - yearA;
            } else if (sortValue.startsWith('added')) {
                const dateA = new Date(a.dataset.added);
                const dateB = new Date(b.dataset.added);
                return sortValue === 'added-asc' ? dateA - dateB : dateB - dateA;
            }
        });

        items.forEach(item => ul.appendChild(item));
    });
}

// Keyword search
const keywordInput = document.getElementById('keyword-search');
if (keywordInput) {
    keywordInput.addEventListener('input', () => {
        const query = keywordInput.value.toLowerCase();
        document.querySelectorAll('.movie-item').forEach(item => {
            const keywords = item.dataset.keywords ? item.dataset.keywords.toLowerCase() : '';
            const matchesKeyword = keywords.includes(query);
            
            // Genre filtering still applies
            const selectedGenre = genreFilter ? genreFilter.value : 'all';
            const movieGenres = item.dataset.genres ? item.dataset.genres.split('|') : [];
            const matchesGenre = (selectedGenre === 'all' || movieGenres.includes(selectedGenre));

            item.style.display = (matchesKeyword && matchesGenre) ? '' : 'none';
        });
    });
}

</script>
{% endblock %}
