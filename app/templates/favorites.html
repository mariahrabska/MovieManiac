{% extends "base.html" %}
{% block title %}Favorite Movies{% endblock %}

{% block content %}
<div class="main-content">
    <div class="container">
        <h2><i class="fas fa-heart"></i> Your Favorite Movies:</h2>

        <!-- Genre filter -->
        {% if genres %}
        <label for="genre-filter">Filter by genre:</label>
                    <div class="autocomplete-wrapper">
        <select id="genre-filter">
            <option value="all">All</option>
            {% for genre in genres %}
                <option value="{{ genre }}">{{ genre }}</option>
            {% endfor %}
        </select>
                    </div>
        {% endif %}

        <!-- Sorting -->
        <label for="sort-by">Sort by:</label>
        <div class="autocomplete-wrapper">
        <select id="sort-by">
            <option value="title-asc">Title A → Z</option>
            <option value="title-desc">Title Z → A</option>
            <option value="year-asc">Year ascending</option>
            <option value="year-desc">Year descending</option>
            <option value="added-desc">Date added (newest)</option>
            <option value="added-asc">Date added (oldest)</option>
        </select>
</div>
        <!-- Keyword search with autocomplete -->
        <label for="keyword-search">Search by keywords:</label>
        <div class="autocomplete-wrapper">
            <input type="text" id="keyword-search" placeholder="Type a keyword...">
            <ul id="keyword-suggestions" class="suggestions-list"></ul>
        </div>

        {% if favorites %}
            <ul class="movie-list">
                {% for movie in favorites %}
                    <li class="movie-item" 
                        data-genres="{{ movie.genres }}" 
                        data-year="{{ movie.release_year }}" 
                        data-added="{{ movie.added_at }}" 
                        data-keywords="{{ movie.keywords|default('') }}">

                        <div class="movie-info">
                            <a href="{{ url_for('main.movie_page', movie_id=movie.movie_id) }}">
                                {% if movie.poster_path %}
                                    <img src="https://image.tmdb.org/t/p/w92{{ movie.poster_path }}" 
                                         alt="{{ movie.title }}" class="poster-thumb">
                                {% endif %}
                                <span class="movie-title">{{ movie.title }}</span>
                            </a>
                        </div>

                        <div class="movie-actions">
                            <button class="remove-btn" data-id="{{ movie.movie_id }}" title="Remove from favorites">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>You don’t have any favorite movies yet.</p>
        {% endif %}
    </div>
</div>

<script>
// Remove movies from favorites
document.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const movie_id = btn.dataset.id;
        fetch('/favorites/toggle', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({movie_id: movie_id})
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                btn.closest('li').remove();
            } else {
                alert("❌ " + (data.error || "Failed to remove the movie from favorites."));
            }
        });
    });
});

// Filter by genre
const genreFilter = document.getElementById('genre-filter');
if (genreFilter) {
    genreFilter.addEventListener('change', filterMovies);
}

// Sorting
const sortSelect = document.getElementById('sort-by');
if (sortSelect) {
    sortSelect.addEventListener('change', () => {
        const ul = document.querySelector('.movie-list');
        const items = Array.from(ul.querySelectorAll('.movie-item'));
        const sortValue = sortSelect.value;

        items.sort((a, b) => {
            if (sortValue.startsWith('title')) {
                const titleA = a.querySelector('.movie-title').textContent.toLowerCase();
                const titleB = b.querySelector('.movie-title').textContent.toLowerCase();
                return sortValue === 'title-asc' ? titleA.localeCompare(titleB) : titleB.localeCompare(titleA);
            } else if (sortValue.startsWith('year')) {
                const yearA = parseInt(a.dataset.year) || 0;
                const yearB = parseInt(b.dataset.year) || 0;
                return sortValue === 'year-asc' ? yearA - yearB : yearB - yearA;
            } else if (sortValue.startsWith('added')) {
                const dateA = new Date(a.dataset.added);
                const dateB = new Date(b.dataset.added);
                return sortValue === 'added-asc' ? dateA - dateB : dateB - dateA;
            }
        });

        items.forEach(item => ul.appendChild(item));
    });
}

// ===============================
// KEYWORD AUTOCOMPLETE
// ===============================
const keywordInput = document.getElementById('keyword-search');
const suggestionsList = document.getElementById('keyword-suggestions');
let allKeywords = [];
let currentIndex = -1;

// Fetch all keywords from server
fetch('/all_keywords')
    .then(res => res.json())
    .then(data => {
        if (Array.isArray(data)) allKeywords = data.map(kw => kw.trim());
        else console.error("Invalid data format /all_keywords:", data);
    });

keywordInput.addEventListener("input", () => {
    const query = keywordInput.value.toLowerCase();
    suggestionsList.innerHTML = "";
    currentIndex = -1;

    if (!query) return;

    const filtered = allKeywords
        .filter(kw => kw.toLowerCase().startsWith(query))
        .slice(0, 5);

    filtered.forEach(kw => {
        const li = document.createElement("li");
        li.className = "suggestion-item";
        li.textContent = kw;
        li.addEventListener("mousedown", e => {
            e.preventDefault();
            selectKeyword(kw);
        });
        suggestionsList.appendChild(li);
    });

    filterMovies();
});

function selectKeyword(keyword) {
    keywordInput.value = keyword;
    suggestionsList.innerHTML = "";
    currentIndex = -1;
    filterMovies();
}

// Keyboard navigation
keywordInput.addEventListener("keydown", function (e) {
    const items = suggestionsList.querySelectorAll(".suggestion-item");
    if (!items.length) return;

    if (e.key === "ArrowDown") {
        e.preventDefault();
        if (currentIndex < items.length - 1) currentIndex++;
        updateActive(items);
    } else if (e.key === "ArrowUp") {
        e.preventDefault();
        if (currentIndex > 0) currentIndex--;
        updateActive(items);
    } else if (e.key === "Enter") {
        e.preventDefault();
        if (currentIndex >= 0 && items[currentIndex]) selectKeyword(items[currentIndex].textContent);
    } else if (e.key === "Escape") {
        suggestionsList.innerHTML = "";
        currentIndex = -1;
    }
});

function updateActive(items) {
    items.forEach((item, i) => item.classList.toggle("active", i === currentIndex));
}

// ===============================
// FILTER MOVIES FUNCTION
// ===============================
function filterMovies() {
    const selectedGenre = genreFilter ? genreFilter.value : 'all';
    const keywordQuery = keywordInput.value.trim().toLowerCase();

    document.querySelectorAll('.movie-item').forEach(item => {
        const genres = item.dataset.genres ? item.dataset.genres.split('|') : [];
        const keywords = item.dataset.keywords ? item.dataset.keywords.toLowerCase().split('|') : [];
        const matchesGenre = selectedGenre === 'all' || genres.includes(selectedGenre);
        const matchesKeyword = !keywordQuery || keywords.some(k => k.includes(keywordQuery));
        item.style.display = (matchesGenre && matchesKeyword) ? '' : 'none';
    });
}

</script>
{% endblock %}
